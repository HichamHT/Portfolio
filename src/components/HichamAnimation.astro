---
// src/components/HichamAnimation.astro

// Props personalizables
export interface Props {
  name?: string;
  images?: {
    main?: string;
    extra1?: string;
    extra2?: string;
    extra3?: string;
  };
}

// Valores por defecto
const { name = "Hicham" } = Astro.props;

// Procesar las imágenes con valores por defecto
const images = {
  main: "https://www.aimeleondore.com/cdn/shop/files/D1810C57-BA63-45A5-A7F8-4C2BBB94C321.jpg?v=1675210814",
  extra1: "https://i.pinimg.com/1200x/7a/e1/c1/7ae1c19850bea7d62f85c8b7a39b3fd6.jpg",
  extra2: "https://i.pinimg.com/736x/4e/60/dd/4e60ddf4faa1ce219ce549d5ceaf2824.jpg",
  extra3: "https://i.pinimg.com/736x/31/7f/9c/317f9cc12e2684d0c81e896aff749aff.jpg",
  ...Astro.props.images
};

// Función para dividir el nombre en letras
function splitName(text: string) {
  const letters = text.split('');
  const middleIndex = Math.floor(letters.length / 2);
  const firstHalf = letters.slice(0, middleIndex);
  const secondHalf = letters.slice(middleIndex);
  
  return { firstHalf, secondHalf };
}

const { firstHalf, secondHalf } = splitName(name);
---

<section class="hicham-header is--loading is--hidden">
  <div class="hicham-loader">
    <div class="hicham__h1">
      <div class="hicham__h1-start">
        {firstHalf.map((letter, index) => (
          <span class="hicham__letter">{letter}</span>
        ))}
      </div>
      <div class="hicham-loader__box">
        <div class="hicham-loader__box-inner">
          <div class="hicham__growing-image">
            <div class="hicham__growing-image-wrap">
              <img class="hicham__cover-image-extra is--1" src={images.extra1} loading="lazy" alt="" />
              <img class="hicham__cover-image-extra is--2" src={images.extra2} loading="lazy" alt="" />
              <img class="hicham__cover-image-extra is--3" src={images.extra3} loading="lazy" alt="" />
              <img class="hicham__cover-image" src={images.main} loading="lazy" alt="" />
            </div>
          </div>
        </div>
      </div>
      <div class="hicham__h1-end">
        {secondHalf.map((letter, index) => (
          <span class="hicham__letter">{letter}</span>
        ))}
      </div>
    </div>
  </div>
  
  <div class="hicham-header__content">
    <div class="hicham-header__top">
      <nav class="hicham-nav">
        <div class="hicham-nav__start">
          <a href="/" class="hicham-nav__link">Desarrollador Full-Stack</a>
        </div>
        <div class="hicham-nav__end">
          <div class="hicham-nav__links">
            <a href="#projects" class="hicham-nav__link">Proyectos</a>
            <a href="#about" class="hicham-nav__link">Sobre mí</a>
            <a href="#contact" class="hicham-nav__link">Contacto</a>
          </div>
        </div>
      </nav>
    </div>
    
    <div class="hicham-header__bottom">
      <div class="hicham__h1">
        {name.split('').map((letter, index) => (
          <span class="hicham__letter-white">
            {letter}
          </span>
        ))}
      </div>
    </div>
  </div>
</section>

<!-- Script corregido con las nuevas clases -->
<script is:inline>
  // Función que solo se ejecuta en el navegador
  const initAnimation = () => {
    // Verificar si estamos en el navegador
    if (typeof window === 'undefined') return;
    
    const container = document.querySelector(".hicham-header");
    if (!container) return;
    
    const loadingLetter = container.querySelectorAll(".hicham__letter");
    const box = container.querySelectorAll(".hicham-loader__box");
    const growingImage = container.querySelectorAll(".hicham__growing-image");
    const headingStart = container.querySelectorAll(".hicham__h1-start");
    const headingEnd = container.querySelectorAll(".hicham__h1-end");
    const coverImageExtra = container.querySelectorAll(".hicham__cover-image-extra");
    const headerLetter = container.querySelectorAll(".hicham__letter-white");
    const navLinks = container.querySelectorAll(".hicham-nav a");
    
    // GSAP Timeline
    const tl = window.gsap.timeline({
      defaults: {
        ease: "expo.inOut",
      },
      onStart: () => {
        container.classList.remove('is--hidden');
      }
    });
    
    // Animación
    if (loadingLetter.length) {
      tl.from(loadingLetter, {
        yPercent: 100,
        stagger: 0.025,
        duration: 1.25
      });
    }
    
    if (box.length) {
      tl.fromTo(box, {
        width: "0em",
      }, {
        width: "1em",
        duration: 1.25
      }, "< 1.25");
    }
    
    if (growingImage.length) {
      tl.fromTo(growingImage, {
        width: "0%",
      }, {
        width: "100%",
        duration: 1.25
      }, "<");
    }
    
    if (headingStart.length) {
      tl.fromTo(headingStart, {
        x: "0em",
      }, {
        x: "-0.05em",
        duration: 1.25
      }, "<");
    }
    
    if (headingEnd.length) {
      tl.fromTo(headingEnd, {
        x: "0em",
      }, {
        x: "0.05em",
        duration: 1.25
      }, "<");
    }
    
    if (coverImageExtra.length) {
      tl.fromTo(coverImageExtra, {
        opacity: 1,
      }, {
        opacity: 0,
        duration: 0.05,
        ease: "none",
        stagger: 0.5
      }, "-=0.05");
    }
    
    if (growingImage.length) {
      tl.to(growingImage, {
        width: "100vw",
        height: "100dvh",
        duration: 2
      }, "< 1.25");
    }
    
    if (box.length) {
      tl.to(box, {
        width: "110vw",
        duration: 2
      }, "<");
    }
    
    if (headerLetter.length) {
      tl.from(headerLetter, {
        yPercent: 100,
        duration: 1.25,
        ease: "expo.out",
        stagger: 0.025
      }, "< 1.2");
    }
    
    if (navLinks.length) {
      tl.from(navLinks, {
        yPercent: 100,
        duration: 1.25,
        ease: "expo.out",
        stagger: 0.1
      }, "<");
    }
  };

  // Cargar GSAP de forma segura
  const loadGSAP = () => {
    // Verificar si estamos en el navegador
    if (typeof window === 'undefined') return;
    
    // Si GSAP ya está cargado, iniciar animación
    if (window.gsap) {
      initAnimation();
      return;
    }
    
    // Cargar GSAP
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js';
    script.onload = initAnimation;
    script.onerror = (error) => {
      console.error('Error cargando GSAP:', error);
    };
    document.head.appendChild(script);
  };

  // Iniciar cuando el DOM esté listo
  if (typeof window !== 'undefined') {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadGSAP);
    } else {
      loadGSAP();
    }
  }
</script>

<style>
  /* Estilos específicos del componente Hicham */
  .hicham-header {
    position: relative;
    overflow: hidden;
    background-color: #201d1d;
    color: #f4f4f4;
    min-height: 100vh;
  }
  
  .hicham-header.is--loading.is--hidden {
    display: none;
  }
  
  .hicham-loader {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    overflow: hidden;
  }
  
  .hicham__h1 {
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 12.5em;
    font-weight: 500;
    line-height: 0.75;
    white-space: nowrap;
  }
  
  .hicham__h1-start,
  .hicham__h1-end {
    display: flex;
    overflow: hidden;
  }
  
  .hicham__h1-start {
    justify-content: flex-end;
    width: 1.9em; /* Aumentado para letras más anchas */
  }
  
  .hicham__h1-end {
    justify-content: flex-start;
    width: 1.9em; /* Aumentado para letras más anchas */
  }
  
  .hicham__letter {
    display: block;
    position: relative;
  }
  
  .hicham-loader__box {
    display: flex;
    flex-flow: column;
    justify-content: center;
    align-items: center;
    width: 0;
    position: relative;
  }
  
  .hicham-loader__box-inner {
    display: flex;
    justify-content: center;
    align-items: center;
    min-width: 1em;
    height: 95%;
    position: relative;
  }
  
  .hicham__growing-image {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 200px;
    height: 200px;
    position: absolute;
    overflow: hidden;
    /* Temporal: fondo para ver el contenedor */
    background-color: rgba(255, 0, 0, 0.5);
  }

  .hicham__growing-image-wrap {
    width: 100%;
    min-width: 1em;
    height: 100%;
    position: absolute;
    /* Temporal: fondo para ver el contenedor */
    background-color: rgba(0, 255, 0, 0.5);
  }
  
  .hicham__cover-image,
  .hicham__cover-image-extra {
    pointer-events: none;
    user-select: none;
    -webkit-user-select: none;
    object-fit: cover;
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
  }
  
  .hicham__cover-image-extra.is--1 { z-index: 3; }
  .hicham__cover-image-extra.is--2 { z-index: 2; }
  .hicham__cover-image-extra.is--3 { z-index: 1; }
  
  .hicham-header__content {
    display: flex;
    flex-flow: column;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    min-height: 100vh;
    padding: 3em;
    position: relative;
  }
  
  .hicham-header__top {
    width: 100%;
    position: relative;
  }
  
  .hicham-header__bottom {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    width: 100%;
    position: relative;
    overflow: hidden;
  }
  
  .hicham-nav {
    display: flex;
    position: relative;
    overflow: hidden;
    width: 100%;
    justify-content: space-between;
    align-items: flex-start;
  }
  
  .hicham-nav__start {
    display: flex;
    justify-content: flex-start;
    align-items: flex-start;
    width: auto;
  }
  
  .hicham-nav__end {
    display: flex;
    justify-content: flex-end;
    align-items: flex-start;
    width: auto;
  }
  
  .hicham-nav__links {
    display: flex;
    gap: 1.5em;
  }
  
  .hicham-nav__link {
    color: #f4f4f4;
    font-size: 1.3125em;
    line-height: 1.3;
    text-decoration: none;
    position: relative;
    transition: opacity 0.3s ease;
  }

  .hicham-nav__link:hover {
    opacity: 0.8;
  }
  
  .hicham__letter-white {
    display: block;
    position: relative;
    color: #f4f4f4;
    width: auto;
  }
  
  .hicham__letter-white.is--space {
    margin-left: 0.25em;
  }
</style>